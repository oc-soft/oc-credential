#!/usr/bin/env sh

. gettext.sh

TEXTDOMAIN=credential-oc
export TEXTDOMAIN

TEXTDOMAINDIR=@TEXTDOMAIN_DIR@
export TEXTDOMAINDIR

client_id=@CLIENT_ID@


function get_user_code() {
  echo $1 | awk '
    BEGIN {
      RS=","
      FS=":"
    }
    /user_code/ {
      if (match($2, /".+"/)) {
        print(substr($2, RSTART + 1, RLENGTH - 2))
      }
    }
  ' -
}

function get_verification_url() {
  echo $1 | awk '
    BEGIN {
      RS=","
      FS=""
    }
    /verification_url/ {
      if (match($0, /\s*"verification_url"\s*:\s*/)) {
        tmp0 = substr($0, RSTART + RLENGTH)
        if (match(tmp0, /".+"/)) {
          print(substr(tmp0, RSTART + 1, RLENGTH - 2))
        }
      }
    }
  ' -
}

function get_expires_in() {
  echo $resp | awk '
    BEGIN {
      RS=","
      FS=":"
    }
    /expires_in/ {
      gsub(/^\s+|\s+$/, "", $2)
      print($2)
    }
  ' -
}

function get_interval() {
  echo $resp | awk '
    BEGIN {
      RS=","
      FS=":"
    }
    /interval/ {
      gsub(/^\s+|\s+$/, "", $2)
      print($2)
    }
  ' -
}

function update_progress_ui()
{
  verification_url=$1
  user_code=$2
  elapse=$3
  eval_gettext "Open following url with your browser($elapse)" ; echo
  echo
  echo $verification_url
  echo 
  eval_gettext "Verification Code: $user_code" ; echo
  echo 
  echo -n "\e[^M"
  echo -n "\e[6 A"
}


resp=`curl -s -d "client_id=${client_id}&scope=email%20profile" \
  https://oauth2.googleapis.com/device/code`

user_code=`get_user_code "$resp"`

verification_url=`get_verification_url "$resp"`

expires_in=`get_expires_in "$resp"`

interval=`get_interval "$resp"`

echo $user_code
echo $verification_url
echo $expires_in
echo $interval

update_progress_ui $verification_url $user_code 5
sleep 1
update_progress_ui $verification_url $user_code 4
sleep 1
update_progress_ui $verification_url $user_code 3
sleep 1
update_progress_ui $verification_url $user_code 2






# vi: se ts=2 sw=2 et:
